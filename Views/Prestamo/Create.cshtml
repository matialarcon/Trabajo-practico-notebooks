@model NotebookApp.Models.Prestamo

@{
    ViewData["Title"] = "Nuevo Préstamo";
    var equiposDisponibles = ViewBag.EquiposDisponibles as List<NotebookApp.Models.Equipo>;
    bool profesorEncontrado = ViewBag.ProfesorEncontrado ?? false;
}

<h2>Registrar Préstamo</h2>

@if (ViewBag.Mensaje != null)
{
    <div class="alert @(profesorEncontrado ? "alert-success" : "alert-danger")">
        @ViewBag.Mensaje
    </div>
}


<form asp-action="Create" method="get" class="mb-4">
    <div class="input-group w-50">
        <input type="text" name="dni" value="@Model?.Profesor?.Dni" class="form-control" placeholder="Ingrese DNI del profesor" required />
        <button type="submit" class="btn btn-outline-primary">Buscar</button>
    </div>
</form>

@if (profesorEncontrado)
{
    <form asp-action="Create" method="post">
        <div class="card p-4 shadow">
            <h4>Datos del Profesor</h4>
            <div class="row mb-3">
                <div class="col-md-4">
                    <label asp-for="Profesor.Dni" class="form-label">DNI</label>
                    <input asp-for="Profesor.Dni" class="form-control" readonly />
                </div>
                <div class="col-md-4">
                    <label asp-for="Profesor.Nombre" class="form-label">Nombre</label>
                    <input asp-for="Profesor.Nombre" class="form-control" value="@Model?.Profesor?.Nombre" readonly />
                </div>
                <div class="col-md-4">
                    <label asp-for="Profesor.Apellido" class="form-label">Apellido</label>
                    <input asp-for="Profesor.Apellido" class="form-control" value="@Model?.Profesor?.Apellido" readonly />
                </div>
            </div>

            <h4>Seleccionar Equipos</h4>

            <div class="mb-3">
                <input type="text" id="buscarEquipo" class="form-control" placeholder="Buscar por número de inventario..." />
            </div>

            <div>
                <label>
                    <input type="checkbox" id="seleccionarTodos" /> Seleccionar todos
                </label>
            </div>

            <div class="table-responsive">
                <div id="mensajeBusqueda" class="alert alert-warning d-none"></div>
                <table class="table table-striped" id="tablaEquipos">
                    <thead>
                        <tr>
                            <th>Seleccionar</th>
                            <th>N° Inventario</th>
                            <th>Marca</th>
                            <th>Modelo</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (equiposDisponibles != null)
                        @foreach (var e in equiposDisponibles)
                        {
                            <tr data-inventario="@e.NumeroInventario.ToLower()">
                                <td>
                                    <input type="checkbox" name="equiposSeleccionados" value="@e.EquipoId"/>
                                </td>
                                <td class="inventario">@e.NumeroInventario</td>
                                <td>@e.Marca</td>
                                <td>@e.Modelo</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>


            <div class="mt-3">
                <button type="submit" class="btn btn-primary">Registrar Salida</button>
                <a asp-action="Index" class="btn btn-secondary">Cancelar</a>
            </div>
        </div>
    </form>
}


@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        const inputBuscar = document.getElementById('buscarEquipo');
        const filas = document.querySelectorAll('#tablaEquipos tbody tr');
        const seleccionarTodos = document.getElementById('seleccionarTodos');
        const mensajeBusqueda = document.getElementById('mensajeBusqueda');

        inputBuscar.addEventListener('input', function () {
            const filtro = this.value.trim().toLowerCase();
            filas.forEach(fila => {
                const inventario = fila.getAttribute('data-inventario');
                if (inventario.includes(filtro)) {
                    fila.style.display = '';
                } else {
                    fila.style.display = 'none';
                }
            });
        });

        inputBuscar.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const filtro = this.value.trim().toLowerCase();
                let encontrado = false;
                mensajeBusqueda.classList.add('d-none');
                mensajeBusqueda.textContent = '';

                if (!filtro) return;

                filas.forEach(fila => {
                    const inventario = fila.getAttribute('data-inventario');
                    const checkbox = fila.querySelector('input[type="checkbox"]');

                    if (!checkbox.checked) {
                        if (inventario.includes(filtro)) {
                            checkbox.checked = true;
                            fila.classList.add('table-success');
                            encontrado = true;
                        } else {
                            fila.classList.remove('table-success');
                        }
                    }

                    fila.style.display = '';
                });

                if (!encontrado) {
                    mensajeBusqueda.textContent = `⚠️ No se encontró ningún equipo con el número de inventario "${this.value}".`;
                    mensajeBusqueda.classList.remove('d-none');
                }

                this.value = '';
            }
        });

        filas.forEach(fila => {
            const checkbox = fila.querySelector('input[type="checkbox"]');
            checkbox.addEventListener('change', function () {
                if (this.checked) {
                    fila.classList.add('table-success');
                } else {
                    fila.classList.remove('table-success');
                }
            });
        });

        seleccionarTodos.addEventListener('change', function () {
            filas.forEach(fila => {
                const checkbox = fila.querySelector('input[type="checkbox"]');
                if (this.checked) {
                    checkbox.checked = true;
                    fila.classList.add('table-success');
                }
                else {
                    checkbox.checked = false;
                    fila.classList.remove('table-success');
                }
            });
        });
    </script>
}

